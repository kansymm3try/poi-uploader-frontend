<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Parking POI Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        /* Style for the popup */
        .mapboxgl-popup-content { font-family: sans-serif; padding: 10px; }
        .mapboxgl-popup-content h3 { margin: 0 0 5px; font-size: 14px; color: #333; }
        .mapboxgl-popup-content p { margin: 0; font-size: 12px; }
        .mapboxgl-popup-content img { margin-top: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2Fuc3ltbTN0cnkiLCJhIjoiY21kbzczZnJlMjQwMDJ2b3N4cnF5ZDRpbyJ9.O96MKO58HtHA9UdcIsM0qQ';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/kansymm3try/cmdo79m5a00bc01s89dcs6so9',
        center: [100.523186, 13.736717], // Starting position centered on Bangkok
        zoom: 11
    });

    // --- HELPER FUNCTIONS ---
    function getAccuracyInstruction(accuracyInMeters) {
        if (!accuracyInMeters || accuracyInMeters === 0) return "Not available";
        if (accuracyInMeters <= 10) return `Very High (spot should be at this pin)`;
        else if (accuracyInMeters <= 25) return `High (look within a few car lengths)`;
        else if (accuracyInMeters <= 50) return `Medium (look in the immediate area)`;
        else return `Low (spot is in this general area, GPS was weak)`;
    }

    // --- THIS FUNCTION FORMATS THE TITLE ---
    function formatPoiType(poiType) {
        if (!poiType) return "Point of Interest";
        switch (poiType) {
            case 'parking_spot':
                return 'Parking Spot';
            case 'pickup':
                return 'Pickup Location';
            case 'dropoff':
                return 'Drop-off Location';
            default:
                return poiType.charAt(0).toUpperCase() + poiType.slice(1);
        }
    }

    map.on('load', () => {
        map.addSource('parking-spots', {
            type: 'geojson',
            data: 'https://map-data-poi.s3.ap-southeast-1.amazonaws.com/map-data.geojson'
        });

        // Layer for the ACCURACY RADIUS CIRCLE
        map.addLayer({
            'id': 'parking-accuracy-layer', 'type': 'circle', 'source': 'parking-spots',
            'paint': { 'circle-radius': ['get', 'accuracy'], 'circle-color': '#007cbf', 'circle-opacity': 0.2, 'circle-stroke-width': 1, 'circle-stroke-color': '#007cbf', 'circle-stroke-opacity': 0.5 }
        });

        // Layer for the CENTER POINT
        map.addLayer({
            'id': 'parking-point-layer', 'type': 'circle', 'source': 'parking-spots',
            'paint': { 'circle-radius': 5, 'circle-color': '#007cbf', 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }
        });

        const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

        map.on('mouseenter', 'parking-point-layer', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;

            // --- USE THE HELPER FUNCTIONS ---
            const poiTitle = formatPoiType(properties.poi_type);
            const accuracyInstruction = getAccuracyInstruction(properties.accuracy);

            // --- UPDATED POPUP ---
            const popupHTML = `
                <h3>${poiTitle}</h3>
                <p><strong>Floor:</strong> ${properties.floor}</p>
                <p><strong>Slot:</strong> ${properties.slot_id}</p>
                <p><strong>Address:</strong> ${properties.address}</p>
                <p><strong>Accuracy:</strong> ${accuracyInstruction}</p>
                <img src="${properties.image_url}" alt="POI Image" width="200" />
            `;
            
            popup.setLngLat(coordinates).setHTML(popupHTML).addTo(map);
        });

        map.on('mouseleave', 'parking-point-layer', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });
    });
</script>

</body>
</html>
